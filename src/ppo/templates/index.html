<!DOCTYPE html>
<html>
<head>
    <title>Play Against Chess Bot</title>
    <link rel="stylesheet" href="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.css">
    
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://unpkg.com/@chrisoakman/chessboardjs@1.0.0/dist/chessboard-1.0.0.min.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.2/chess.min.js"></script>
</head>
<body>
    <h1>Play Against GeminiChess</h1>
    <div id="myBoard" style="width: 400px"></div>
    <h3 id="status"></h3>

    <script>
        var board = null;
        var game = new Chess();

        function onDrop(source, target) {
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' // NOTE: always promote to a queen for simplicity
            });

            // If move is illegal, snap back
            if (move === null) return 'snapback';

            // Send the move to the server
            $.ajax({
                url: '/move',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ move: move.san }),
                success: function(response) {
                    game.load(response.fen);
                    board.position(response.fen);
                    updateStatus();
                }
            });
        }

        function updateStatus() {
            var status = '';
            var moveColor = 'White';
            if (game.turn() === 'b') {
                moveColor = 'Black';
            }

            if (game.in_checkmate()) {
                status = 'Game over, ' + moveColor + ' is in checkmate.';
            } else if (game.in_draw()) {
                status = 'Game over, drawn position.';
            } else {
                status = moveColor + ' to move.';
                if (game.in_check()) {
                    status += ', ' + moveColor + ' is in check.';
                }
            }
            $('#status').html(status);
        }

        var config = {
            draggable: true,
            position: 'start',
            onDrop: onDrop
        };
        board = Chessboard('myBoard', config);
        updateStatus();
    </script>
</body>
<script>
    // This function ensures the code runs only after the webpage is fully loaded.
    $(function() {
        var board = null;
        var game = new Chess();
        var statusEl = $('#status');

        // This function is called when a piece is dropped on a square.
        function onDrop(source, target) {
            // See if the move is legal
            var move = game.move({
                from: source,
                to: target,
                promotion: 'q' // NOTE: Always promote to a queen for simplicity
            });

            // If the move is illegal, snap the piece back
            if (move === null) return 'snapback';

            // The move was legal, so send it to the server
            $.ajax({
                url: '/move',
                type: 'POST',
                contentType: 'application/json',
                // Send the move in UCI format (e.g., 'e2e4')
                data: JSON.stringify({ move: source + target }),
                success: function(response) {
                    // Update the board with the FEN string from the server
                    game.load(response.fen);
                    board.position(response.fen);
                    updateStatus();
                }
            });
        }

        // This function is called when a piece is picked up.
        function onSnapEnd() {
            // Update the board position after the piece snap
            // for castling, en passant, pawn promotion
            board.position(game.fen());
        }

        function updateStatus() {
            var status = '';
            var moveColor = 'White';
            if (game.turn() === 'b') {
                moveColor = 'Black';
            }

            if (game.in_checkmate()) {
                status = 'Game over, ' + moveColor + ' is in checkmate.';
            } else if (game.in_draw()) {
                status = 'Game over, drawn position.';
            } else {
                status = moveColor + ' to move.';
                if (game.in_check()) {
                    status += ', ' + moveColor + ' is in check.';
                }
            }
            statusEl.html(status);
        }

        // Configuration for the chessboard
        var config = {
            draggable: true,
            position: 'start', // This will now correctly show the starting pieces
            onDrop: onDrop,
            onSnapEnd: onSnapEnd
        };
        
        // Initialize the board
        board = Chessboard('myBoard', config);
        updateStatus();
    });
</script>
</html>